<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SupportOps Dashboard (AI Ready)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 18px; }
    input[type="text"]{ padding:8px; width:320px; }
    button{ padding:8px 12px; margin-left:8px; cursor:pointer; }
    .ticket{ border:1px solid #ddd; padding:10px; margin-bottom:8px; border-radius:6px; background:#fff; }
    .meta{ color:#666; font-size:12px; margin-top:6px; }
    .ai-box { margin-top:8px; padding:8px; border-left:3px solid #eee; background:#fafafa; border-radius:4px; }
  </style>
</head>
<body>
  <header>
    <h1>SupportOps Dashboard (AI Ready)</h1>
    <div class="badge" id="status">Not connected</div>
  </header>

  <form id="createForm">
    <input id="title" type="text" placeholder="Describe your support issue..." />
    <button>Create Ticket</button>
  </form>

  <h2>Tickets</h2>
  <div id="tickets"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const statusEl = document.getElementById('status');
    socket.on('connect', () => {
      statusEl.textContent = 'Connected';
      statusEl.style.background = '#28a745';
      statusEl.style.color = '#fff';
      statusEl.style.padding = '6px 10px';
      statusEl.style.borderRadius = '6px';
    });
    socket.on('disconnect', () => {
      statusEl.textContent = 'Disconnected';
      statusEl.style.background = '#dc3545';
    });

    const ticketsEl = document.getElementById('tickets');
    let tickets = [];

    function renderTickets() {
      ticketsEl.innerHTML = '';
      tickets.forEach(t => {
        const d = document.createElement('div');
        d.className = 'ticket';

        const color = (t.priority === 'urgent') ? '#c0392b'
                    : (t.priority === 'high') ? '#e67e22'
                    : (t.priority === 'medium') ? '#f1c40f'
                    : '#2ecc71';

        const badge = `<span style="background:${color};color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;margin-right:8px">${t.priority}</span>`;

        const reply = t.suggestedReply
          ? `<div class="ai-box"><strong>AI Suggested Reply:</strong><br>${escapeHtml(t.suggestedReply)}</div>`
          : '';

        d.innerHTML = `
          ${badge} <strong>${escapeHtml(t.title)}</strong>
          <div class="meta">${t.status} â€¢ ${new Date(t.createdAt).toLocaleString()}</div>
          ${reply}
        `;

        ticketsEl.appendChild(d);
      });
    }

    function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    socket.on('init', data => {
      tickets = data.tickets;
      renderTickets();
    });

    socket.on('ticket:new', t => {
      tickets.unshift(t);
      renderTickets();
    });

    document.getElementById('createForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      if (!title) return alert('Please describe your issue.');

      await fetch('/api/tickets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title })
      });

      document.getElementById('title').value = '';
    });
  </script>
</body>
</html>
